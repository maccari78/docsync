<div class="container-fluid mt-3 px-4 d-flex flex-column" style="min-height: 100vh;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Appointment Details</h1>
    <div class="d-flex gap-3 gap-md-2">
      <% if patient? %>
        <% patient = Patient.find_by(email: current_user.email) %>
        <% if patient && @appointment.patient_id == patient.id && @appointment.confirmed? %>
          <% can_pay = !@appointment.payment || @appointment.payment.pending? %>
          <% if can_pay %>
            <%= button_to "Pay Appointment", initiate_payment_appointment_path(@appointment), method: :post, class: "btn btn-primary", data: { turbo: false } %>
          <% end %>
        <% end %>
      <% end %>
      <% if admin? || professional? || (secretary? && current_secretary.professionals.include?(@appointment.professional)) %>
        <%= link_to "Edit Appointment", edit_appointment_path(@appointment), class: "btn btn-warning" %>
        <%= button_to "Delete Appointment", 
          appointment_path(@appointment), 
          method: :delete, 
          form: { data: { turbo_confirm: "Are you sure?" } }, 
          class: "btn btn-danger" %>
      <% end %>
      <%= link_to "Back to Calendar", appointments_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>Patient:</strong> <%= @appointment.patient&.name || 'N/A' %></p>
      <p><strong>Professional:</strong> <%= @appointment.professional&.user&.name || 'N/A' %></p>
      <p><strong>Clinic:</strong> <%= @appointment.clinic&.name || 'N/A' %></p>
      <p><strong>Date:</strong> <%= @appointment.date&.strftime('%Y-%m-%d') || 'N/A' %></p>
      <p><strong>Time:</strong> <%= @appointment.time&.strftime('%H:%M') || 'N/A' %></p>
      <p><strong>Status:</strong> <%= @appointment.status&.humanize&.capitalize || 'N/A' %></p>
      <% if @appointment.payment %>
        <p><strong>Payment Status:</strong> <%= @appointment.payment.status&.humanize&.capitalize || 'N/A' %></p>
      <% end %>
      <% if @appointment.conversation && %w[confirmed completed].include?(@appointment.status) %>
          <%= link_to 'Open Chat', conversation_path(@appointment.conversation), class: 'btn btn-primary mt-3' %>
        <% end %>
        <%= link_to 'Back to Calendar', appointments_path, class: 'btn btn-secondary mt-3' %>
      </div>
    </div>
  </div>
</div>
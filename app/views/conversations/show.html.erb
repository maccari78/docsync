<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Chat con <%= @conversation.sender == current_user ? "#{@conversation.receiver&.first_name} #{@conversation.receiver&.last_name}" : "#{@conversation.sender&.first_name} #{@conversation.sender&.last_name}" %></h1>
    <span class="flex-grow-1 text-center fs-6">Turno: <%= @conversation.appointment.treatment_details %> - <%= @conversation.appointment.date.strftime('%d/%m/%Y') %></span>
    <div class="d-flex gap-3">
      <%= link_to 'Back to Appointment', appointment_path(@conversation.appointment), class: 'btn btn-secondary' %>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-body" id="messages" style="max-height: 400px; overflow-y: auto;" data-current-user-email="<%= current_user.email %>" data-current-user-full-name="<%= "#{current_user.first_name} #{current_user.last_name}" %>">
      <% @messages.each do |message| %>
        <div id="message-<%= message.id %>" class="mb-2 <%= message.user == current_user ? 'text-end' : 'text-start' %>">
          <strong><%= "#{message.user&.first_name} #{message.user&.last_name}" || 'Unknown User' %>:</strong> <%= message.content %>
          <small class="text-muted">(<%= message.created_at&.strftime('%H:%M') || 'No Date' %>)</small>
        </div>
      <% end %>
    </div>
    <div class="card-footer">
      <%= form_with model: @message, url: conversation_messages_path(@conversation), local: true do |f| %>
        <div class="input-group">
          <%= f.text_area :content, class: 'form-control', rows: 2, required: true %>
          <%= f.submit 'Enviar', class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>
<meta name="conversation-id" content="<%= @conversation.id %>">